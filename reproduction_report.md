# LEAD 论文复现报告

**论文**: LEAD: Learning Decomposition for Source-free Universal Domain Adaptation (CVPR 2024)

**复现框架**: PyTorch (原版) + Jittor (计图框架移植)

**实验设备**: macOS (MPS后端), 使用 `--num_workers 0`

---

## 1. 复现总结

| 场景 | 数据集 | 指标 | 论文(%) | PyTorch复现(%) | 完成度 | 计图复现(%) | 完成度 |
|------|--------|------|---------|---------------|--------|------------|--------|
| OPDA | Office | H-score | 87.8 | 85.1 | 6/6 | 56.1 | 2/6 |
| OPDA | OfficeHome | H-score | 75.0 | 74.0 | 10/12 | — | 0/12 |
| OPDA | VisDA | H-score | 76.6 | 73.5 | 1/1 | — | 0/1 |
| OSDA | Office | H-score | 90.3 | 90.0 | 6/6 | — | 0/6 |
| OSDA | OfficeHome | H-score | 67.2 | — | 0/12 | — | 0/12 |
| OSDA | VisDA | H-score | 74.2 | — | 0/1 | — | 0/1 |
| PDA | Office | KnownAcc | 95.5 | 95.1 | 6/6 | — | 0/6 |
| PDA | OfficeHome | KnownAcc | 73.8 | — | 0/12 | — | 0/12 |
| PDA | VisDA | KnownAcc | 75.3 | — | 0/1 | — | 0/1 |

---

## 2. 详细实验结果

### 2.1 OPDA 场景

#### Office (H-score)

| 迁移方向 | 论文 H-score(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| A2D | 85.4 | 78.2 | -7.2 | 62.4 | -23.0 |
| A2W | 85.0 | 78.5 | -6.5 | 49.9 | -35.1 |
| D2A | 86.3 | 85.7 | -0.6 | — | — |
| D2W | 90.9 | 91.5 | +0.6 | — | — |
| W2A | 86.2 | 85.3 | -0.9 | — | — |
| W2D | 93.1 | 91.5 | -1.6 | — | — |
| **Avg** | **87.8** | **85.1** | **-2.7** | **56.1** | **-31.7** |

#### OfficeHome (H-score)

| 迁移方向 | 论文 H-score(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| Ar2Cl | 62.7 | 57.3 | -5.4 | — | — |
| Ar2Pr | 78.1 | 77.8 | -0.3 | — | — |
| Ar2Rw | 86.4 | 85.9 | -0.5 | — | — |
| Cl2Ar | 70.6 | 73.3 | +2.7 | — | — |
| Cl2Pr | 76.3 | 72.0 | -4.3 | — | — |
| Cl2Rw | 83.4 | 83.7 | +0.3 | — | — |
| Pr2Ar | 75.3 | 70.5 | -4.8 | — | — |
| Pr2Cl | 60.6 | 59.6 | -1.0 | — | — |
| Pr2Rw | 86.2 | 86.3 | +0.1 | — | — |
| Rw2Ar | 75.4 | 74.0 | -1.4 | — | — |
| Rw2Cl | 60.7 | 进行中 | — | — | — |
| Rw2Pr | 83.7 | 进行中 | — | — | — |
| **Avg** | **75.0** | **74.0** | **-0.9** | **—** | **—** |

#### VisDA (H-score)

| 迁移方向 | 论文 H-score(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| S2R | 76.6 | 73.5 | -3.1 | — | — |
| **Avg** | **76.6** | **73.5** | **-3.1** | **—** | **—** |

### 2.2 OSDA 场景

#### Office (H-score)

| 迁移方向 | 论文 H-score(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| A2D | 84.9 | 86.2 | +1.3 | — | — |
| A2W | 85.1 | 87.5 | +2.4 | — | — |
| D2A | 90.2 | 86.9 | -3.3 | — | — |
| D2W | 94.8 | 93.7 | -1.1 | — | — |
| W2A | 90.3 | 88.8 | -1.5 | — | — |
| W2D | 96.5 | 97.1 | +0.6 | — | — |
| **Avg** | **90.3** | **90.0** | **-0.3** | **—** | **—** |

#### OfficeHome (H-score)

| 迁移方向 | 论文 H-score(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| Ar2Cl | 60.7 | 进行中 | — | — | — |
| Ar2Pr | 70.8 | 进行中 | — | — | — |
| Ar2Rw | 76.5 | 进行中 | — | — | — |
| Cl2Ar | 61.0 | 进行中 | — | — | — |
| Cl2Pr | 68.6 | 进行中 | — | — | — |
| Cl2Rw | 70.8 | 进行中 | — | — | — |
| Pr2Ar | 65.5 | 进行中 | — | — | — |
| Pr2Cl | 59.8 | 进行中 | — | — | — |
| Pr2Rw | 74.2 | 进行中 | — | — | — |
| Rw2Ar | 64.8 | 进行中 | — | — | — |
| Rw2Cl | 57.7 | 进行中 | — | — | — |
| Rw2Pr | 75.8 | 进行中 | — | — | — |
| **Avg** | **67.2** | **—** | **—** | **—** | **—** |

#### VisDA (H-score)

| 迁移方向 | 论文 H-score(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| S2R | 74.2 | 进行中 | — | — | — |
| **Avg** | **74.2** | **—** | **—** | **—** | **—** |

### 2.3 PDA 场景

#### Office (KnownAcc)

| 迁移方向 | 论文 KnownAcc(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| A2D | 89.8 | 87.9 | -1.9 | — | — |
| A2W | 93.9 | 93.9 | -0.0 | — | — |
| D2A | 95.6 | 94.9 | -0.7 | — | — |
| D2W | 98.6 | 98.6 | +0.0 | — | — |
| W2A | 96.0 | 96.0 | +0.0 | — | — |
| W2D | 99.4 | 99.4 | +0.0 | — | — |
| **Avg** | **95.5** | **95.1** | **-0.4** | **—** | **—** |

#### OfficeHome (KnownAcc)

| 迁移方向 | 论文 KnownAcc(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| Ar2Cl | 58.2 | 进行中 | — | — | — |
| Ar2Pr | 83.1 | 进行中 | — | — | — |
| Ar2Rw | 87.0 | 进行中 | — | — | — |
| Cl2Ar | 70.5 | 进行中 | — | — | — |
| Cl2Pr | 75.4 | 进行中 | — | — | — |
| Cl2Rw | 83.3 | 进行中 | — | — | — |
| Pr2Ar | 73.7 | 进行中 | — | — | — |
| Pr2Cl | 50.4 | 进行中 | — | — | — |
| Pr2Rw | 83.7 | 进行中 | — | — | — |
| Rw2Ar | 78.3 | 进行中 | — | — | — |
| Rw2Cl | 58.7 | 进行中 | — | — | — |
| Rw2Pr | 83.2 | 进行中 | — | — | — |
| **Avg** | **73.8** | **—** | **—** | **—** | **—** |

#### VisDA (KnownAcc)

| 迁移方向 | 论文 KnownAcc(%) | PyTorch复现(%) | Δ | 计图复现(%) | Δ |
|----------|------------------|---------------|------|------------|------|
| S2R | 75.3 | 进行中 | — | — | — |
| **Avg** | **75.3** | **—** | **—** | **—** | **—** |

---

## 3. 结果分析

### 3.1 PyTorch 复现分析

- **Office-31 OPDA**: 平均H-score 85.1% vs 论文87.8%，差距-2.7%。主要在A→D和A→W两个迁移方向上偏低（~78% vs ~85%），其余方向接近论文水平
- **Office-31 OSDA**: 平均H-score 90.0% vs 论文90.3%，差距仅-0.3%，基本完全复现
- **Office-31 PDA**: 平均KnownAcc 95.1% vs 论文95.5%，差距-0.4%，基本完全复现
- **OfficeHome OPDA**: 已完成10/12对，平均H-score 74.1% vs 论文75.0%(全12对)，接近论文结果
- **VisDA OPDA**: H-score 73.5% vs 论文76.6%，差距-3.1%

### 3.2 计图编译器适配 — macOS ARM 修复

Jittor v1.3.10 在 macOS ARM64 (Apple Silicon) 上无法直接运行，根本原因是其 JIT 编译器在生成算子注册表 `data.cc` 时，使用了指向成员函数的指针 (PMF) 强制转换：

```cpp
(void(*)(Node*)) &Node::forward   // ❌ macOS clang 严格模式下非法
```

macOS ARM64 的 clang 严格遵循 C++ 标准，禁止 PMF → 普通函数指针的不安全转换，导致编译直接报错。

**修改方案**（修改文件：`site-packages/jittor/compiler.py` 第1363-1389行，共新增27行）：

1. 使用 `clang -E` 预处理源码，得到展开后的 `.pp.cc` 文件
2. 注入基于 union 类型双关的安全转换模板函数：
   ```cpp
   template<typename To, typename From>
   To unsafe_pmf_cast(From f) { union { From from; To to; } u; u.from = f; return u.to; }
   ```
3. 用正则表达式替换所有 PMF 强转：
   ```
   (void(*)(Node*))&Node::xx → unsafe_pmf_cast<void(*)(Node*)>(&Node::xx)
   ```
4. 编译修改后的预处理文件，清理临时文件
5. 仅在 `platform.system() == 'Darwin'` 时触发，不影响 Linux/Windows 平台

### 3.3 PyTorch → 计图 代码移植关键差异

| 改动项 | PyTorch 写法 | Jittor 适配写法 | 说明 |
|--------|-------------|----------------|------|
| 模型前向传播 | `forward(self, x)` | `execute(self, x)` | Jittor 约定 |
| 权重归一化 | `nn.utils.weight_norm()` | 手写 `WeightNormLinear` 类 | Jittor 无内置，手动实现 g·v/‖v‖ |
| 线性层计算 | `F.linear(x, w, b)` | `matmul_transpose(x, w) + b` | 矩阵转置乘法替代 |
| 反向传播 | `loss.backward(); optim.step()` | `optimizer.step(loss)` | 一步完成自动微分 |
| 冻结参数 | `requires_grad_(False)` | `v.stop_grad()` | 梯度阻断方式不同 |
| 数据集 | `torch.utils.data.Dataset` | `jt.dataset.Dataset` + `set_attrs()` | 内置 DataLoader 功能 |
| 图像归一化 | `transforms.Normalize()` | `jt.transform.ImageNormalize()` | API 名称不同 |
| 随机种子 | `torch.manual_seed()` | `jt.set_global_seed()` | 统一全局随机种子 |
| 设备管理 | `cuda / mps / cpu` | 自动管理（仅 CPU/CUDA） | Jittor 不支持 MPS |
| 检查点 | `.pth` (torch.save) | `.pkl` + `load_pytorch_weights()` | 可桥接加载 PyTorch 权重 |

### 3.4 计图 (Jittor) 复现分析

- 目前仅完成 Office-31 OPDA 的 A→D (62.4%) 和 A→W (49.9%) 两对实验
- 结果与论文/PyTorch版本差距较大，可能原因：
  1. Jittor 仅支持 CPU 运行（不支持 Mac MPS），训练 epoch 不足
  2. Jittor 与 PyTorch 在随机数生成、BatchNorm 行为等方面存在差异
  3. 训练可能尚未收敛（部分实验仍在进行中）

### 3.5 总体结论

1. **PyTorch版本复现成功**: Office-31三个场景的平均结果与论文差距均在3%以内，OSDA和PDA几乎完全复现
2. **OfficeHome和VisDA结果接近论文**: 在已完成的实验中，复现结果与论文基本一致
3. **计图版本仍需完善**: 当前结果有限且偏低，需要进一步调试和完整训练
